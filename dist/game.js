/*! missilewar 27-04-2015 */
function logPlay(){_gaq.push(["_trackEvent","Button","Play"])}function start(){var a=new Date;window.app=new SL.Game({canvas:document.getElementById("GameCanvas")}),app.fullscreen(),app.assetCollection=new SL.AssetCollection("res/assets.json",app,function(){_gaq.push(["_trackEvent","Game","Load","",(new Date-a)/1e3]),$(".canvas-container").append(domjs.build(templates.modal));var b=new SL.Scene("loading",[],function(){},app);b.addEntity(new SL.Loader({assetCollection:app.assetCollection,screenSize:SCREEN_SIZE,loadCallback:function(){app.transitionScene("menu")},barColor:"blue",textColor:"green"}));var c=new SL.Scene("menu",[],function(){var a=$(".modal");a.append(domjs.build(templates.menu)),$(".menu .button").on("click",function(){a.empty(),a.off(),app.transitionScene($(this).attr("id"))})},app),d=new SL.Scene("game",[],function(){var a=$(".modal");a.empty(),a.off(),a.hide(),$(".game-ui").show(),app.currentScene.addEntity(new Platform({position:new SL.Vec2(SCREEN_SIZE.x/2,SCREEN_SIZE.y-256),type:"basic",trim:16711680})),app.currentScene.addEntity(new Platform({position:new SL.Vec2(SCREEN_SIZE.x/2,192),type:"basic",facing:{x:1,y:-1},trim:255})),app.currentScene.addEntity(new Player),app.currentScene.stage.setBackgroundColor(0)},app),e=new SL.Scene("score",[],function(a){var b=$(".modal");b.append(domjs.build(templates.score)),b.show(),$(".menu .button").on("click",function(){b.empty(),b.off(),app.transitionScene($(this).attr("id"))})},app);app.addScene(b),app.addScene(c),app.addScene(d),app.addScene(e),app.transitionScene("loading"),app.start()})}function Projectile(a){var b=this,c=app.assetCollection.assets.projectiles[a.type];b.silo=a.silo,b.state="idle",b.tag="projectile",b.type=a.type,b.target=a.target,b.sprite=new PIXI.Sprite(app.assetCollection.getTexture("projectile-"+a.type)),b.sprite.position=b.silo.collider.origin.clone(),b.sprite.origin=new SL.Vec2(.5,.5),b.sprite.rotation=(180+b.sprite.position.angleBetween(b.target.collider.origin))*DEGREES_TO_RADIANS,b.sprite.shader=new ColorReplaceFilter(16777215,a.silo.platform.trim,.1),b.collider=new SL.Circle(b.sprite.position,2),b.direction=b.sprite.position.getDirectionVector(b.target.collider.origin);for(var d in c)c.hasOwnProperty(d)&&(b[d]=c[d]);b.update=function(){b.target&&"exploding"!==b.target.state&&"exploded"!==b.target.state&&null!==b.target.state||"exploded"===b.state||(b.state="exploding"),"exploding"!==b.state&&"exploded"!==b.state?(b.sprite.position.translate(b.direction.getScaled(b.speed*app.deltaTime)),b.collider.translate(b.direction.getScaled(b.speed*app.deltaTime)),b.target.platform.collider.intersects(b.collider)&&"active"===b.target.platform.shieldState?(b.state="exploding",b.target.platform.shield-=b.damage):b.target.collider.intersects(b.collider)&&(b.state="exploding",b.target.health-=b.damage)):"exploding"===b.state?b.state="exploded":"exploded"===b.state&&app.currentScene.removeEntity(b)}}function Tile(a){var b=this;b.idleTexture=app.assetCollection.getTexture("tile"),b.activeTexture=app.assetCollection.getTexture("tile-active"),b.sprite=new PIXI.Sprite(app.assetCollection.getTexture("tile")),b.sprite.position=a.position.clone(),b.sprite.shader=new ColorReplaceFilter(16777215,16777215,.1),b.tag="tile",b.type="tile",b.collider=new SL.Rect(a.position,TILE_SIZE),b.platform=a.platform,b.building=null,b.state="idle",b.update=function(){},b.setState=function(a){b.state=a,b.sprite.setTexture("active"===b.state?b.activeTexture:b.idleTexture)}}function Building(a){var b,c=this;c.tag="building",c.platform=a.platform,c.tile=a.tile,c.type=a.type,c.subType=a.subType||null,c.sprite=new PIXI.Sprite(app.assetCollection.getTexture(a.subType?a.type+"-"+a.subType:a.type)),c.sprite.position=c.tile.collider.origin.clone(),c.sprite.shader=new ColorReplaceFilter(16777215,a.platform.trim,.1),c.sprite.anchor=new SL.Vec2(.5,.5),c.state="idle",c.collider=new SL.Circle(c.tile.collider.origin,TILE_SIZE.x/4),b=c.subType?app.assetCollection.assets.buildings[c.type][c.subType]:app.assetCollection.assets.buildings[c.type];for(var d in b)b.hasOwnProperty(d)&&(c[d]=b[d],"interval"===d&&(c.timeToEvent=b[d]));"booster"===c.type&&(c.platform.maxShield+=c.boostAmount),"silo"===c.type&&(c.projectileQueue=[c.autofire],c.timeToFire=c.fireDelay,c.target=null),c.update=function(){c.health<=0&&"exploded"!==c.state&&(c.state="exploding"),"idle"===c.state&&(void 0!==c.timeToEvent&&null!==c.timeToEvent?c.timeToEvent-=app.deltaTime:null),"exploding"!==c.state&&"exploded"!==c.state?(void 0!==c.timeToEvent&&null!==c.timeToEvent&&c.timeToEvent<=0&&("generator"===c.type?c.platform.energy+=c.amount:"silo"===c.type?(c.target=c.platform.findTarget(),c.state="firing",c.timeToFire=0):"booster"===c.type&&c.platform.regenShield(c.regenAmount),c.timeToEvent=c.interval),"firing"===c.state&&(c.timeToFire-=app.deltaTime,c.timeToFire<=0&&(0===c.projectileQueue.length?(c.state="idle",c.queueProjectile(c.autofire),c.timeToFire=0):(c.fire(),c.timeToFire=c.fireDelay)))):"exploded"!==c.state?c.state="exploded":"command"!==c.type&&(c.tile.building=null,app.currentScene.removeEntity(c))},c.upgrade=function(a){for(var b,d=!1,e=0;e<c.upgrades.length;e++)if(c.upgrades[e]===a){d=!0;break}if(d){c.platform.maxShield-="booster"===c.type?c.boostAmount:0,c.subType=a,c.sprite.setTexture(app.assetCollection.getTexture(c.type+"-"+c.subType)),b=app.assetCollection.assets.buildings[c.type][c.subType];for(var f in b)b.hasOwnProperty(f)&&(c[f]=b[f]);c.platform.maxShield+="booster"===c.type?c.boostAmount:0}},c.queueProjectile=function(a){c.projectileQueue.length<c.capacity&&"firing"!==c.state&&c.platform.energy-app.assetCollection.assets.projectiles[a].cost>0&&(c.projectileQueue.push(a),c.platform.energy-=app.assetCollection.assets.projectiles[a].cost)},c.fire=function(){var a=c.projectileQueue.pop();app.currentScene.addEntity(new Projectile({silo:c,type:a,target:c.target}))},c.sell=function(){}}function Platform(a){var b=this,c=app.assetCollection.assets.platforms[a.type],d=0;b.tag="platform",b.type=a.type,b.trim=a.trim,b.maxShield=PLATFORM_INITIAL_MAX_SHIELD,b.shield=b.maxShield,b.shieldState="active",b.shieldSprite=new PIXI.Sprite(app.assetCollection.getTexture("shield")),b.shieldSprite.anchor=new SL.Vec2(.5,.5),b.energy=PLATFORM_INITIAL_ENERGY,b.buildings=a.buildings||[],b.tiles=a.tiles||[],b.corePosition=a.position.clone(),b.facing=a.facing||{x:1,y:1},b.command=null;for(var e=0;e<c.length;e++)d=Math.abs(c[e].x)>d?Math.abs(c[e].x):d,d=Math.abs(c[e].y)>d?Math.abs(c[e].y):d,b.tiles.push(new Tile({position:a.position.getTranslated(new SL.Vec2(b.facing.x*c[e].x*TILE_SIZE.x,b.facing.y*c[e].y*TILE_SIZE.y)),platform:b})),c[e].building&&(b.tiles[e].building=new Building({type:c[e].building.type,subType:c[e].building.subType,platform:b,tile:b.tiles[e]}),"command"===c[e].building.type&&(b.command=b.tiles[e].building)),app.currentScene.addEntity(b.tiles[e]),c[e].building&&app.currentScene.addEntity(b.tiles[e].building);b.collider=new SL.Circle(b.command.collider.origin,(d+2)*TILE_SIZE.x),b.shieldSprite.width=b.collider.diameter,b.shieldSprite.height=b.collider.diameter,b.shieldSprite.position=b.command.collider.origin.clone(),app.currentScene.camera.addChild(b.shieldSprite),b.update=function(){b.energy+=PLATFORM_PASSIVE_ENERGY_INCOME*app.deltaTime,"active"===b.shieldState&&(b.shieldSprite.alpha=SL.Tween.lerp(0,1,b.shield/b.maxShield)),b.shield<=0?(b.shieldState="recharging",b.shieldSprite.alpha=0):"recharging"===b.shieldState&&b.shield>=.25*b.maxShield&&(b.shieldState="active")},b.regenShield=function(a){b.shield=b.shield+a>b.maxShield?b.maxShield:b.shield+a},b.findTarget=function(){for(var a,c,d,e=app.currentScene.getEntitiesByTag("platform"),f=0;f<e.length;f++)if(e[f].entityID!==b.entityID){a=e[f];break}for(f=0;f<a.tiles.length;f++)if(a.tiles[f].building){if("command"!==a.tiles[f].building.type){c=a.tiles[f].building;break}d=a.tiles[f].building}return c=c?c:d}}function Player(){function a(a){var c;"tile"===b.selection.type?(c=new Building({type:a.currentTarget.dataset.type,subType:a.currentTarget.dataset.subtype,platform:b.platform,tile:b.selection}),b.selection.building=c,b.selection.setState("idle"),app.currentScene.addEntity(c),b.previousSelection=b.selection,b.selection=c,b.updateSelectionUI()):"projectile"!==a.currentTarget.dataset.type?(b.selection.upgrade(a.currentTarget.dataset.subtype),b.previousSelection=null,b.updateSelectionUI()):b.selection.queueProjectile(a.currentTarget.dataset.subtype)}var b=this,c=["silo-rocket","generator-solar","booster-small"];b.buildings=app.assetCollection.assets.buildings,b.selection=null,b.previousSelection=null,b.time=0,b.platform=app.currentScene.getEntitiesByTag("platform")[0],$(".build-option").on("click",a),b.update=function(){var a,c={rect:new SL.Rect(app.mouseLocation.getTranslated(app.currentScene.camera.position.getScaled(-1)),new SL.Vec2(1,1)),circle:new SL.Circle(app.mouseLocation.getTranslated(app.currentScene.camera.position.getScaled(-1)),1)},d=app.currentScene.getEntitiesByTag("tile");b.updateUI(),app.isKeyDown(KEYS.up)?app.currentScene.camera.position.translate(new SL.Vec2(0,CAMERA_PAN_SPEED*app.deltaTime)):app.isKeyDown(KEYS.down)&&app.currentScene.camera.position.translate(new SL.Vec2(0,-CAMERA_PAN_SPEED*app.deltaTime)),app.isKeyDown(KEYS.left)?app.currentScene.camera.position.translate(new SL.Vec2(CAMERA_PAN_SPEED*app.deltaTime,0)):app.isKeyDown(KEYS.right)&&app.currentScene.camera.position.translate(new SL.Vec2(-CAMERA_PAN_SPEED*app.deltaTime,0));for(var e=0;e<d.length;e++)if(c.rect.intersects(d[e].collider)&&d[e].platform.entityID===b.platform.entityID){d[e].state="active",a=d[e];break}app.onMouseUp()&&a&&(b.selection?a.building&&b.selection.entityID!==a.building.entityID?(b.previousSelection=b.selection,b.selection=a.building):a.building||(b.previousSelection=b.selection,b.selection=a,b.selection.setState("active")):(a.building?b.selection=a.building:(b.selection=a,a.setState("active")),b.previousSelection=null),b.updateSelectionUI(),b.previousSelection&&"tile"===b.previousSelection.type&&b.selection.entityID!==b.previousSelection.entityID&&b.previousSelection.setState("idle"))},b.updateUI=function(){b.time+=app.deltaTime,window["play-time"].innerHTML=Math.floor(b.time/60).toString()+":"+(b.time%60<10?"0"+Math.floor(b.time%60):Math.floor(b.time%60)),window["player-platform-shield"].innerHTML=Math.floor(b.platform.shield)+"/"+Math.floor(b.platform.maxShield),window["player-platform-energy"].innerHTML=Math.floor(b.platform.energy)},b.updateSelectionUI=function(){if($(".build-option").hide(),$(".selection-item").hide(),b.previousSelection&&"tile"!==b.previousSelection.type&&(window["selection-item-"+b.previousSelection.type+(b.previousSelection.subType?"-"+b.previousSelection.subType:"")].style.display="none"),b.selection)if("tile"===b.selection.type)for(var a=0;a<c.length;a++)window["build-option-"+c[a]].style.display="initial";else{if(window["selection-item-"+b.selection.type+(b.selection.subType?"-"+b.selection.subType:"")].style.display="initial",b.selection.upgrades)for(a=0;a<b.selection.upgrades.length;a++)window["build-option-"+b.selection.type+"-"+b.selection.upgrades[a]].style.display="initial";if(b.selection.fires)for(a=0;a<b.selection.fires.length;a++)window["build-option-projectile-"+b.selection.fires[a]].style.display="initial"}}}SL=sugarLab,PIXI.scaleModes.DEFAULT=PIXI.scaleModes.NEAREST;var SCREEN_SIZE=new SL.Vec2(document.documentElement.clientWidth,document.documentElement.clientHeight),TILE_SIZE=new SL.Vec2(64,64),PLATFORM_INITIAL_MAX_SHIELD=100,PLATFORM_INITIAL_ENERGY=500,PLATFORM_PASSIVE_ENERGY_INCOME=2,CAMERA_PAN_SPEED=200,DEGREES_TO_RADIANS=.0174532925,KEYS={up:87,down:83,left:65,right:68},ColorReplaceFilter=function(a,b,c){PIXI.AbstractFilter.call(this),this.uniforms={findColor:{type:"3f",value:null},replaceWithColor:{type:"3f",value:null},range:{type:"1f",value:null}},this.findColor=a,this.replaceWithColor=b,this.range=c,this.passes=[this],this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","uniform sampler2D texture;","uniform vec3 findColor;","uniform vec3 replaceWithColor;","uniform float range;","void main(void) {","  vec4 currentColor = texture2D(texture, vTextureCoord);","  vec3 colorDiff = findColor - (currentColor.rgb / max(currentColor.a, 0.0000000001));","  float colorDistance = length(colorDiff);","  float doReplace = step(colorDistance, range);","  gl_FragColor = vec4(mix(currentColor.rgb, (replaceWithColor + colorDiff) * currentColor.a, doReplace), currentColor.a);","}"]};ColorReplaceFilter.prototype=Object.create(PIXI.AbstractFilter.prototype),ColorReplaceFilter.prototype.constructor=ColorReplaceFilter,Object.defineProperty(ColorReplaceFilter.prototype,"findColor",{set:function(a){var b=((16711680&a)>>16)/255,c=((65280&a)>>8)/255,d=(255&a)/255;this.uniforms.findColor.value={x:b,y:c,z:d},this.dirty=!0}}),Object.defineProperty(ColorReplaceFilter.prototype,"replaceWithColor",{set:function(a){var b=((16711680&a)>>16)/255,c=((65280&a)>>8)/255,d=(255&a)/255;this.uniforms.replaceWithColor.value={x:b,y:c,z:d},this.dirty=!0}}),Object.defineProperty(ColorReplaceFilter.prototype,"range",{set:function(a){this.uniforms.range.value=a,this.dirty=!0}});